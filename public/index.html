<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bảng điều khiển Bot Binance Futures</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function Dashboard() {
      const [balance, setBalance] = useState(0);
      const [positions, setPositions] = useState([]);
      const [signals, setSignals] = useState([]);
      const [logs, setLogs] = useState([]);
      const [isConnected, setIsConnected] = useState(false);
      const [error, setError] = useState(null);
      const wsRef = useRef(null);
      const reconnectAttempts = useRef(0);
      const maxReconnectAttempts = 5;

      const connectWebSocket = () => {
        if (reconnectAttempts.current >= maxReconnectAttempts) {
          setError('Không thể kết nối với server sau nhiều lần thử');
          return;
        }

        const ws = new WebSocket('ws://localhost:8080');
        wsRef.current = ws;

        ws.onopen = () => {
          setIsConnected(true);
          setLogs((prev) => [...prev, `${new Date().toISOString()} - Đã kết nối với server`]);
          reconnectAttempts.current = 0;
          setError(null);
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'balance') {
              setBalance(parseFloat(data.balance) || 0);
            } else if (data.type === 'positions') {
              setPositions(data.positions || []);
            } else if (data.type === 'signals') {
              setSignals(data.signals || []);
            } else if (data.type === 'log') {
              setLogs((prev) => [...prev, data.message].slice(-100));
            }
          } catch (e) {
            setError('Dữ liệu từ server không hợp lệ');
            setLogs((prev) => [...prev, `${new Date().toISOString()} - Lỗi dữ liệu: ${e.message}`]);
          }
        };

        ws.onclose = () => {
          setIsConnected(false);
          setLogs((prev) => [...prev, `${new Date().toISOString()} - Mất kết nối với server`]);
          reconnectAttempts.current += 1;
          setTimeout(connectWebSocket, 2000);
        };

        ws.onerror = (err) => {
          setError('Lỗi kết nối WebSocket');
          setLogs((prev) => [...prev, `${new Date().toISOString()} - Lỗi WebSocket: ${err.message || 'Không xác định'}`]);
        };
      };

      const handleRefresh = () => {
        reconnectAttempts.current = 0;
        if (wsRef.current) {
          wsRef.current.close();
        }
        connectWebSocket();
      };

      useEffect(() => {
        connectWebSocket();
        return () => {
          if (wsRef.current) {
            wsRef.current.close();
          }
        };
      }, []);

      if (error && !isConnected) {
        return (
          <div className="container mx-auto p-4">
            <h1 className="text-3xl font-bold mb-4">Bảng điều khiển Bot Binance Futures</h1>
            <div className="bg-red-100 border border-red-400 text-red-700 p-4 rounded">
              <p>Lỗi: {error}</p>
              <p>Vui lòng kiểm tra xem backend (bot.js) có đang chạy trên cổng 8080 không.</p>
              <button
                onClick={handleRefresh}
                className="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
              >
                Thử kết nối lại
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="container mx-auto p-4">
          <h1 className="text-3xl font-bold mb-4">Bảng điều khiển Bot Binance Futures</h1>

          <div className="mb-4 flex items-center">
            <p className={isConnected ? 'text-green-600' : 'text-red-600'}>
              {isConnected ? 'Đã kết nối với server' : 'Mất kết nối với server'}
            </p>
            <button
              onClick={handleRefresh}
              className="ml-4 bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600"
            >
              Làm mới
            </button>
          </div>

          <div className="mb-6">
            <h2 className="text-xl font-semibold">Số dư</h2>
            <p className="text-lg">USDT: {balance.toFixed(2)}</p>
          </div>

          <div className="mb-6">
            <h2 className="text-xl font-semibold">Vị thế đang mở</h2>
            {positions.length === 0 ? (
              <p>Không có vị thế đang mở</p>
            ) : (
              <table className="w-full border-collapse border border-gray-300">
                <thead>
                  <tr className="bg-gray-200">
                    <th className="border border-gray-300 p-2">Cặp</th>
                    <th className="border border-gray-300 p-2">Loại</th>
                    <th className="border border-gray-300 p-2">Giá vào</th>
                    <th className="border border-gray-300 p-2">Số lượng</th>
                    <th className="border border-gray-300 p-2">Chốt lời</th>
                    <th className="border border-gray-300 p-2">Cắt lỗ</th>
                    <th className="border border-gray-300 p-2">Lợi nhuận (USDT)</th>
                  </tr>
                </thead>
                <tbody>
                  {positions.map((pos, index) => (
                    <tr key={index} className="hover:bg-gray-100">
                      <td className="border border-gray-300 p-2">{pos.symbol || '-'}</td>
                      <td className="border border-gray-300 p-2">{pos.side?.toUpperCase() || '-'}</td>
                      <td className="border border-gray-300 p-2">{pos.entry?.toFixed(2) || '-'}</td>
                      <td className="border border-gray-300 p-2">{pos.amount?.toFixed(4) || '-'}</td>
                      <td className="border border-gray-300 p-2">{pos.tp?.toFixed(2) || '-'}</td>
                      <td className="border border-gray-300 p-2">{pos.sl?.toFixed(2) || '-'}</td>
                      <td className="border border-gray-300 p-2">{pos.pnl?.toFixed(2) || '0.00'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>

          <div className="mb-6">
            <h2 className="text-xl font-semibold">Tín hiệu giao dịch</h2>
            {signals.length === 0 ? (
              <p>Không có tín hiệu giao dịch</p>
            ) : (
              <table className="w-full border-collapse border border-gray-300">
                <thead>
                  <tr className="bg-gray-200">
                    <th className="border border-gray-300 p-2">Cặp</th>
                    <th className="border border-gray-300 p-2">RSI</th>
                    <th className="border border-gray-300 p-2">SMA</th>
                    <th className="border border-gray-300 p-2">MACD</th>
                    <th className="border border-gray-300 p-2">Tín hiệu</th>
                  </tr>
                </thead>
                <tbody>
                  {signals.map((sig, index) => (
                    <tr key={index} className="hover:bg-gray-100">
                      <td className="border border-gray-300 p-2">{sig.symbol || '-'}</td>
                      <td className="border border-gray-300 p-2">{sig.rsi?.toFixed(2) || '-'}</td>
                      <td className="border border-gray-300 p-2">{sig.sma || '-'}</td>
                      <td className="border border-gray-300 p-2">{sig.macd || '-'}</td>
                      <td className="border border-gray-300 p-2">{sig.signal || '-'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>

          <div>
            <h2 className="text-xl font-semibold">Nhật ký hoạt động</h2>
            <div className="bg-white p-4 h-64 overflow-y-auto border border-gray-300">
              {logs.length === 0 ? (
                <p>Không có nhật ký hoạt động</p>
              ) : (
                logs.map((log, index) => (
                  <p key={index} className="text-sm">{log}</p>
                ))
              )}
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Dashboard />);
  </script>
</body>
</html>